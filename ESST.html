// Coded and designed by Tierney Lee, Becky Gilbert, Maris Vainre, and Marc Bennet
<!DOCTYPE html>
<html>
    <head>
        <title>Emotion go stop</title>
        <script src="jspsych-6.1.0/jspsych.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
        <script src = "block_trials/block1_info.js"></script>
        <script src = "block_trials/block2_info.js"></script>
        <script src = "block_trials/block3_info.js"></script>
        <script src = "block_trials/practice_info.js"></script>
        <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body></body>
    <script>

        // no-go stimulus image path
        var stop_image = 'signals/stop_signal.bmp';
        //set up fixation
        var fixation_image = 'signals/fixpoint.png';
        //set up feedback images
        var correct_image = 'signals/correct.bmp'
        var wrong_image = 'signals/incorrect.bmp'
        //set up SSD
        var delay = 250;
        //set up trial counts
        var trial_absolute_count = 1;
        var practice_within_count = 1;
        var practice_go_count = 1;
        var practice_stop_count = 1;
        var block1_within_count = 1;
        var block1_go_count = 1;
        var block1_stop_count = 1;
        var block2_within_count = 1;
        var block2_go_count = 1;
        var block2_stop_count = 1;
        var block3_within_count = 1;
        var block3_go_count = 1;
        var block3_stop_count = 1;

        // set up block trial data
        var practice_trial_info = practice_info;
        var randomize_block_trials = jsPsych.randomization.shuffle([block1, block2, block3]);
        var block1_trial_info = jsPsych.randomization.shuffle(randomize_block_trials[0]);
        var block2_trial_info = jsPsych.randomization.shuffle(randomize_block_trials[1]);
        var block3_trial_info = jsPsych.randomization.shuffle(randomize_block_trials[2]);

        //set up timeline
        var timeline = [];

        // see docs for more info on the instructions plugin: https://www.jspsych.org/plugins/jspsych-instructions/
        var instructions = {
            type: 'instructions',
            pages: [
                "<p>In this task, you will see a photograph followed by an arrow. </p>" +
                "<p>The arrows may point to the left or to the right. </p>" +
                "<p>If the arrow is pointing to the left, then you should press the C-key.</p>" +
                "<p>If the arrow is pointing to the right, then you should press the N-key.</p>" +
                "<p>Try to respond as quickly as possible whilst not making any mistakes.</p>" +
                "<p>Click the next button to continue.</p>",
                "<p>Sometimes, the left/right arrow will be followed unexpectedly by an arrow pointing upwards.</p>" +
                "<p>When this happens YOU MUST NOT RESPOND.</p>" +
                "<p>Press the next button to continue</p>",
                "<p>So remember:</p>" +
                "<p>(1) Press the C-key when you see the left arrow.</p>" +
                "<p>(2) Press the N-key when you see the right arrow. </p>" +
                "<p>(3) But you have to stop if the up arrow appers.</p>" +
                "<p>You can first practice this task with some feedback.</p>" +
                "<p>Press the next button to begin the task.</p>"
              ],
            show_clickable_nav: true
        };
        timeline.push(instructions);

        // set up feedback and conditions for practice trials
        var too_slow_message = {
            type: 'html-keyboard-response',
            stimulus: '<p style="color:red; font-size:20px;">Please respond faster.</p>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 500,
            post_trial_gap: 1000,
            data: {trial_segment: 'too_slow'}
        }
        var too_slow_conditional = {
            timeline: [too_slow_message],
            conditional_function: function() {
                var last_trial_data = jsPsych.data.get().last(1).values()[0];
                if (last_trial_data.trial_segment == "target") {
                    return true;
                } else {
                    return false;
                }
            }
        }

        var practice_correct_go = {
            type: 'image-keyboard-response',
            stimulus: correct_image,
            choices: jsPsych.NO_KEYS,
            trial_duration: 500,
            post_trial_gap: 1000,
            data: {trial_segment: 'practice_correct_go'}
        }

        var practice_correct_go_conditional = {
            timeline: [practice_correct_go],
            conditional_function: function() {
                var last_trial_data = jsPsych.data.get().last(1).values()[0];
                if (last_trial_data.trial_response == last_trial_data.trial_response_correct) {
                    return true;
                } else {
                    return false;
                }
            }
        }

        var practice_wrong_go = {
            type: 'image-keyboard-response',
            stimulus: wrong_image,
            choices: jsPsych.NO_KEYS,
            trial_duration: 500,
            post_trial_gap: 1000,
            data: {trial_segment: 'practice_wrong_go'}
        }

        var practice_wrong_go_conditional = {
            timeline: [practice_wrong_go],
            conditional_function: function() {
                var last_trial_data = jsPsych.data.get().last(1).values()[0];
                if (last_trial_data.key_press !== null && last_trial_data.trial_response !== last_trial_data.trial_response_correct) {
                    return true;
                } else {
                    return false;
                }
            }
        }

        var practice_correct_stop = {
            type: 'image-keyboard-response',
            stimulus: correct_image,
            choices: jsPsych.NO_KEYS,
            trial_duration: 500,
            post_trial_gap: 1000,
            data: {trial_segment: 'practice_correct_stop'}
        }

        var practice_correct_stop_conditional = {
            timeline: [practice_correct_stop],
            conditional_function: function() {
                var last_trial_data = jsPsych.data.get().last(1).values()[0];
                if (last_trial_data.correct == true) {
                    return true;
                } else {
                    return false;
                }
            }
        }

        var practice_wrong_stop = {
            type: 'image-keyboard-response',
            stimulus: wrong_image,
            choices: jsPsych.NO_KEYS,
            trial_duration: 500,
            post_trial_gap: 1000,
            data: {trial_segment: 'practice_wrong_stop'}
        }

        var practice_wrong_stop_conditional = {
            timeline: [practice_wrong_stop],
            conditional_function: function() {
                var last_trial_data = jsPsych.data.get().last(1).values()[0];
                if (last_trial_data.trial_segment !== "stop_signal") {
                    return false;
                } else {
                    return true;
                }
            }
        }

        //set up practice block
        for (var i=0; i<practice_trial_info.length; i++) {
            // add fixation to this trial
            // set up the fixation, since this will be the same for all trials
            var fixation = {
                type: 'image-keyboard-response',
                stimulus: fixation_image,
                choices: jsPsych.NO_KEYS,
                trial_duration: 500,
                data: {trial_segment: 'fixation', condition: practice_trial_info[i].condition}
            }
            timeline.push(fixation);
            // set up emotion image and add to this trial
            var emotion = {
                type: 'image-keyboard-response',
                stimulus: practice_trial_info[i].emotion_image,
                choices: jsPsych.NO_KEYS,
                trial_duration: 1000,
                data: {trial_segment: 'emotion', condition: practice_trial_info[i].condition}
            }
            timeline.push(emotion);

            // set up stop signal trials
            if (practice_trial_info[i].condition == "stop") {
                // set up target arrow and add to this trial
                var target_arrow = {
                    type: 'image-keyboard-response',
                    stimulus: practice_trial_info[i].arrow_image,
                    choices: ['c','n'],
                    response_ends_trial: false,
                    trial_duration: function() {
                      return delay;
                    },
                    data: {
                      trial_segment: 'target',
                      condition: practice_trial_info[i].condition
                    }
                }
                timeline.push(target_arrow);
                // set up stop signal and add to this trial
                var stop_signal = {
                    type: 'image-keyboard-response',
                    stimulus: stop_image,
                    choices: ['c','n'],
                    response_ends_trial: false,
                    trial_duration: 1000,
                    post_trial_gap: 1000,
                    data: {
                      block: 'practice',
                      trial_absolute: function() {
                        return trial_absolute_count;
                      },
                      trial_within: function() {
                        return practice_within_count;
                      },
                      trial_stop_number: function() {
                        return practice_stop_count;
                      },
                      emotion_type: practice_trial_info[i].emotion_type,
                      trial_segment: 'stop_signal',
                      condition: practice_trial_info[i].condition,
                      arrow_direction: practice_trial_info[i].arrow_direction,
                      arrow_key_correct: practice_trial_info[i].arrow_key_correct,
                      trial_response_correct: practice_trial_info[i].trial_response_correct,
                      SSD: function() {
                        return delay;
                      }
                    },
                    on_finish: function(data) {
                        // score response
                        trial_absolute_count += 1;
                        practice_stop_count += 1;
                        practice_within_count += 1;
                        var correct = true;
                        var inhibit = 1;
                        var last_trial_data = jsPsych.data.get().last(2).values()[0];
                        var trial_response = 'x';
                        var current_delay = 0;
                        // if unsuccesful inhibition, decrease SSD so that it is easier to stop
                        if (data.key_press !== null || last_trial_data.key_press !== null) {
                            correct = false;
                            inhibit = 0;
                            delay -= 25;

                            if (last_trial_data.key_press !== null) {
                              data.rt = last_trial_data.rt;
                            }

                            else if (data.key_press !== null) {
                              data.rt = data.rt + current_delay;
                            }

                            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c" || jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(last_trial_data.key_press) == "c") {
                                trial_response = 'l';
                            }
                            else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n" || jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(last_trial_data.key_press) == "n") {
                                trial_response = 'r';
                            }
                        }
                        // if successful inhibition, increase SSD so that it is harder to stop
                        else {
                          delay += 25;
                        }

                        // add accuracy to the data for this trial
                        data.trial_response = trial_response;
                        data.successful_inhibit = inhibit;
                        data.correct = correct;
                    }
                }
                // add the no-go arrow trial (no-go trials only)
                timeline.push(stop_signal);
                // add the practice feedback (practice block only)
                timeline.push(practice_correct_stop_conditional);
                timeline.push(practice_wrong_stop_conditional);
            } else {
                // set up the go trial and add to timeline
                var target_arrow = {
                    type: 'image-keyboard-response',
                    stimulus: practice_trial_info[i].arrow_image,
                    choices: ['c','n'],
                    response_ends_trial: true,
                    trial_duration: 1000,
                    post_trial_gap: 500,
                    data: {
                      block: 'practice',
                      trial_absolute: function() {
                        return trial_absolute_count;
                      },
                      trial_within: function() {
                        return practice_within_count;
                      },
                      trial_go_number: function() {
                        return practice_go_count;
                      },
                      emotion_type: practice_trial_info[i].emotion_type,
                      trial_segment: 'target',
                      condition: practice_trial_info[i].condition,
                      arrow_direction: practice_trial_info[i].arrow_direction,
                      arrow_key_correct: practice_trial_info[i].arrow_key_correct,
                      trial_response_correct: practice_trial_info[i].trial_response_correct
                    },
                    on_finish: function(data) {
                        // score response
                        trial_absolute_count += 1;
                        practice_go_count += 1;
                        practice_within_count += 1;
                        var correct = false;
                        var trial_response = 'x';
                        // if we add the correct key response to the trial data, then we can use it to score the response
                        if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == data.arrow_key_correct) {
                            correct = true;
                        }

                        if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                            trial_response = 'l';
                        }
                        else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                            trial_response = 'r';
                        }
                        // add accuracy to data for this trial
                        data.correct = correct;
                        data.trial_response = trial_response;
                    }
                };
                timeline.push(target_arrow);
                // add the too slow conditional node (go trials only)
                timeline.push(practice_correct_go_conditional);
                timeline.push(practice_wrong_go_conditional);
                timeline.push(too_slow_conditional);
            }
        }
        // set up instructions post practice
        var post_practice_instructions = {
            type: 'instructions',
            pages: ["<p>By now, you probably have an idea about what to do. If you have any questions, contact the experimenter. If you do not have any questions, feel free to continue. </p>" +
                "<p>From now on there will be no feedback on your performance.  </p>" +
                "<p>Remember: </p>" +
                "<p>(1) Press the C-key when you see the left arrow.</p>" +
                "<p>(2) Press the M-key when you see the right arrow. </p>" +
                "<p>(3) But you have to stop if the up arrow appers. </p>" +
                "<p>Press the next button to begin.</p>",
              ],
            show_clickable_nav: true
        };
        timeline.push(post_practice_instructions);

        //set up block1
        for (var i=0; i<block1_trial_info.length; i++) {
            // add fixation to this trial
            // set up the fixation, since this will be the same for all trials
            var fixation = {
                type: 'image-keyboard-response',
                stimulus: fixation_image,
                choices: jsPsych.NO_KEYS,
                trial_duration: 500,
                data: {trial_segment: 'fixation', condition: block1_trial_info[i].condition}
            }
            timeline.push(fixation);
            // set up emotion image and add to this trial
            var emotion = {
                type: 'image-keyboard-response',
                stimulus: block1_trial_info[i].emotion_image,
                choices: jsPsych.NO_KEYS,
                trial_duration: 1000,
                data: {trial_segment: 'emotion', condition: block1_trial_info[i].condition}
            }
            timeline.push(emotion);

            // set up stop signal trials
            if (block1_trial_info[i].condition == "stop") {
                // set up target arrow and add to this trial
                var target_arrow = {
                    type: 'image-keyboard-response',
                    stimulus: block1_trial_info[i].arrow_image,
                    choices: ['c','n'],
                    response_ends_trial: false,
                    trial_duration: function() {
                      return delay;
                    },
                    data: {
                      trial_segment: 'target',
                      condition: block1_trial_info[i].condition
                    }
                }
                timeline.push(target_arrow);
                // set up stop signal and add to this trial
                var stop_signal = {
                    type: 'image-keyboard-response',
                    stimulus: stop_image,
                    choices: ['c','n'],
                    response_ends_trial: false,
                    trial_duration: 1000,
                    post_trial_gap: 1000,
                    data: {
                      block: 'block1',
                      trial_absolute: function() {
                        return trial_absolute_count;
                      },
                      trial_within: function() {
                        return block1_within_count;
                      },
                      trial_stop_number: function() {
                        return block1_stop_count;
                      },
                      emotion_type: block1_trial_info[i].emotion_type,
                      trial_segment: 'stop_signal',
                      condition: block1_trial_info[i].condition,
                      arrow_direction: block1_trial_info[i].arrow_direction,
                      arrow_key_correct: block1_trial_info[i].arrow_key_correct,
                      trial_response_correct: block1_trial_info[i].trial_response_correct,
                      SSD: function() {
                        return delay;
                      }
                    },
                    on_finish: function(data) {
                        // score response
                        trial_absolute_count += 1;
                        block1_stop_count += 1;
                        block1_within_count += 1;
                        var correct = true;
                        var inhibit = 1;
                        var last_trial_data = jsPsych.data.get().last(2).values()[0];
                        var trial_response = 'x';
                        var current_delay = 0;
                        // if unsuccesful inhibition, decrease SSD so that it is easier to stop
                        if (data.key_press !== null || last_trial_data.key_press !== null) {
                            correct = false;
                            inhibit = 0;
                            delay -= 25;

                            if (last_trial_data.key_press !== null) {
                              data.rt = last_trial_data.rt;
                            }

                            else if (data.key_press !== null) {
                              data.rt = data.rt + current_delay;
                            }

                            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c" || jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(last_trial_data.key_press) == "c") {
                                trial_response = 'l';
                            }
                            else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n" || jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(last_trial_data.key_press) == "n") {
                                trial_response = 'r';
                            }
                        }
                        // if successful inhibition, increase SSD so that it is harder to stop
                        else {
                          delay += 25;
                        }

                        // add accuracy to the data for this trial
                        data.trial_response = trial_response;
                        data.successful_inhibit = inhibit;
                        data.correct = correct;
                    }
                }
                // add the no-go arrow trial (no-go trials only)
                timeline.push(stop_signal);
            } else {
                // set up the go trial and add to timeline
                var target_arrow = {
                    type: 'image-keyboard-response',
                    stimulus: block1_trial_info[i].arrow_image,
                    choices: ['c','n'],
                    response_ends_trial: true,
                    trial_duration: 1000,
                    post_trial_gap: 500,
                    data: {
                      block: 'block1',
                      trial_absolute: function() {
                        return trial_absolute_count;
                      },
                      trial_within: function() {
                        return block1_within_count;
                      },
                      trial_go_number: function() {
                        return block1_go_count;
                      },
                      emotion_type: block1_trial_info[i].emotion_type,
                      trial_segment: 'target',
                      condition: block1_trial_info[i].condition,
                      arrow_direction: block1_trial_info[i].arrow_direction,
                      arrow_key_correct: block1_trial_info[i].arrow_key_correct,
                      trial_response_correct: block1_trial_info[i].trial_response_correct
                    },
                    on_finish: function(data) {
                        // score response
                        trial_absolute_count += 1;
                        block1_go_count += 1;
                        block1_within_count += 1;
                        var correct = false;
                        var trial_response = 'x';
                        // if we add the correct key response to the trial data, then we can use it to score the response
                        if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == data.arrow_key_correct) {
                            correct = true;
                        }

                        if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                            trial_response = 'l';
                        }
                        else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                            trial_response = 'r';
                        }
                        // add accuracy to data for this trial
                        data.correct = correct;
                        data.trial_response = trial_response;
                    }
                };
                timeline.push(target_arrow);
            }
        }

        //set up instructions post block 1
        var post_block1_instructions = {
            type: 'instructions',
            pages: ["<p>You are nearly finished. But you can take a break if you'd like. </p>" +
                "<p>Press the next button when you are ready to continue.  </p>"
              ],
            show_clickable_nav: true
        };
        timeline.push(post_block1_instructions);

        //set up block 2
        for (var i=0; i<block2_trial_info.length; i++) {
            // add fixation to this trial
            // set up the fixation, since this will be the same for all trials
            var fixation = {
                type: 'image-keyboard-response',
                stimulus: fixation_image,
                choices: jsPsych.NO_KEYS,
                trial_duration: 500,
                data: {trial_segment: 'fixation', condition: block2_trial_info[i].condition}
            }
            timeline.push(fixation);
            // set up emotion image and add to this trial
            var emotion = {
                type: 'image-keyboard-response',
                stimulus: block2_trial_info[i].emotion_image,
                choices: jsPsych.NO_KEYS,
                trial_duration: 1000,
                data: {trial_segment: 'emotion', condition: block2_trial_info[i].condition}
            }
            timeline.push(emotion);

            // set up stop signal trials
            if (block2_trial_info[i].condition == "stop") {
                // set up target arrow and add to this trial
                var target_arrow = {
                    type: 'image-keyboard-response',
                    stimulus: block2_trial_info[i].arrow_image,
                    choices: ['c','n'],
                    response_ends_trial: false,
                    trial_duration: function() {
                      return delay;
                    },
                    data: {
                      trial_segment: 'target',
                      condition: block2_trial_info[i].condition
                    }
                }
                timeline.push(target_arrow);
                // set up stop signal and add to this trial
                var stop_signal = {
                    type: 'image-keyboard-response',
                    stimulus: stop_image,
                    choices: ['c','n'],
                    response_ends_trial: false,
                    trial_duration: 1000,
                    post_trial_gap: 1000,
                    data: {
                      block: 'block2',
                      trial_absolute: function() {
                        return trial_absolute_count;
                      },
                      trial_within: function() {
                        return block2_within_count;
                      },
                      trial_stop_number: function() {
                        return block2_stop_count;
                      },
                      emotion_type: block2_trial_info[i].emotion_type,
                      trial_segment: 'stop_signal',
                      condition: block2_trial_info[i].condition,
                      arrow_direction: block2_trial_info[i].arrow_direction,
                      arrow_key_correct: block2_trial_info[i].arrow_key_correct,
                      trial_response_correct: block2_trial_info[i].trial_response_correct,
                      SSD: function() {
                        return delay;
                      }
                    },
                    on_finish: function(data) {
                        // score response
                        trial_absolute_count += 1;
                        block2_stop_count += 1;
                        block2_within_count += 1;
                        var correct = true;
                        var inhibit = 1;
                        var last_trial_data = jsPsych.data.get().last(2).values()[0];
                        var trial_response = 'x';
                        var current_delay = 0;
                        // if unsuccesful inhibition, decrease SSD so that it is easier to stop
                        if (data.key_press !== null || last_trial_data.key_press !== null) {
                            correct = false;
                            inhibit = 0;
                            delay -= 25;

                            if (last_trial_data.key_press !== null) {
                              data.rt = last_trial_data.rt;
                            }

                            else if (data.key_press !== null) {
                              data.rt = data.rt + current_delay;
                            }

                            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c" || jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(last_trial_data.key_press) == "c") {
                                trial_response = 'l';
                            }
                            else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n" || jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(last_trial_data.key_press) == "n") {
                                trial_response = 'r';
                            }
                        }
                        // if successful inhibition, increase SSD so that it is harder to stop
                        else {
                          delay += 25;
                        }

                        // add accuracy to the data for this trial
                        data.trial_response = trial_response;
                        data.successful_inhibit = inhibit;
                        data.correct = correct;
                    }
                }
                // add the no-go arrow trial (no-go trials only)
                timeline.push(stop_signal);
            } else {
                // set up the go trial and add to timeline
                var target_arrow = {
                    type: 'image-keyboard-response',
                    stimulus: block2_trial_info[i].arrow_image,
                    choices: ['c','n'],
                    response_ends_trial: true,
                    trial_duration: 1000,
                    post_trial_gap: 500,
                    data: {
                      block: 'block2',
                      trial_absolute: function() {
                        return trial_absolute_count;
                      },
                      trial_within: function() {
                        return block2_within_count;
                      },
                      trial_go_number: function() {
                        return block2_go_count;
                      },
                      emotion_type: block2_trial_info[i].emotion_type,
                      trial_segment: 'target',
                      condition: block2_trial_info[i].condition,
                      arrow_direction: block2_trial_info[i].arrow_direction,
                      arrow_key_correct: block2_trial_info[i].arrow_key_correct,
                      trial_response_correct: block2_trial_info[i].trial_response_correct
                    },
                    on_finish: function(data) {
                        // score response
                        trial_absolute_count += 1;
                        block2_go_count += 1;
                        block2_within_count += 1;
                        var correct = false;
                        var trial_response = 'x';
                        // if we add the correct key response to the trial data, then we can use it to score the response
                        if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == data.arrow_key_correct) {
                            correct = true;
                        }

                        if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                            trial_response = 'l';
                        }
                        else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                            trial_response = 'r';
                        }
                        // add accuracy to data for this trial
                        data.correct = correct;
                        data.trial_response = trial_response;
                    }
                };
                timeline.push(target_arrow);
                // add the too slow conditional node (go trials only)
            }
        }

        //set up instructions post block 2
        var post_block2_instructions = {
            type: 'instructions',
            pages: ["<p>You are nearly finished. But you can take a break if you'd like. </p>" +
                "<p>Press the next button when you are ready to continue.  </p>"
              ],
            show_clickable_nav: true
        };
        timeline.push(post_block2_instructions);

        //set up block 3
        for (var i=0; i<block3_trial_info.length; i++) {
            // add fixation to this trial
            // set up the fixation, since this will be the same for all trials
            var fixation = {
                type: 'image-keyboard-response',
                stimulus: fixation_image,
                choices: jsPsych.NO_KEYS,
                trial_duration: 500,
                data: {trial_segment: 'fixation', condition: block3_trial_info[i].condition}
            }
            timeline.push(fixation);
            // set up emotion image and add to this trial
            var emotion = {
                type: 'image-keyboard-response',
                stimulus: block3_trial_info[i].emotion_image,
                choices: jsPsych.NO_KEYS,
                trial_duration: 1000,
                data: {trial_segment: 'emotion', condition: block3_trial_info[i].condition}
            }
            timeline.push(emotion);

            // set up stop signal trials
            if (block3_trial_info[i].condition == "stop") {
                // set up target arrow and add to this trial
                var target_arrow = {
                    type: 'image-keyboard-response',
                    stimulus: block3_trial_info[i].arrow_image,
                    choices: ['c','n'],
                    response_ends_trial: false,
                    trial_duration: function() {
                      return delay;
                    },
                    data: {
                      trial_segment: 'target',
                      condition: block3_trial_info[i].condition
                    }
                }
                timeline.push(target_arrow);
                // set up stop signal and add to this trial
                var stop_signal = {
                    type: 'image-keyboard-response',
                    stimulus: stop_image,
                    choices: ['c','n'],
                    response_ends_trial: false,
                    trial_duration: 1000,
                    post_trial_gap: 1000,
                    data: {
                      block: 'block3',
                      trial_absolute: function() {
                        return trial_absolute_count;
                      },
                      trial_within: function() {
                        return block3_within_count;
                      },
                      trial_stop_number: function() {
                        return block3_stop_count;
                      },
                      emotion_type: block3_trial_info[i].emotion_type,
                      trial_segment: 'stop_signal',
                      condition: block3_trial_info[i].condition,
                      arrow_direction: block3_trial_info[i].arrow_direction,
                      arrow_key_correct: block3_trial_info[i].arrow_key_correct,
                      trial_response_correct: block3_trial_info[i].trial_response_correct,
                      SSD: function() {
                        return delay;
                      }
                    },
                    on_finish: function(data) {
                        // score response
                        trial_absolute_count += 1;
                        block3_stop_count += 1;
                        block3_within_count += 1;
                        var correct = true;
                        var inhibit = 1;
                        var last_trial_data = jsPsych.data.get().last(2).values()[0];
                        var trial_response = 'x';
                        var current_delay = 0;
                        // if unsuccesful inhibition, decrease SSD so that it is easier to stop
                        if (data.key_press !== null || last_trial_data.key_press !== null) {
                            correct = false;
                            inhibit = 0;
                            delay -= 25;

                            if (last_trial_data.key_press !== null) {
                              data.rt = last_trial_data.rt;
                            }

                            else if (data.key_press !== null) {
                              data.rt = data.rt + current_delay;
                            }

                            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c" || jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(last_trial_data.key_press) == "c") {
                                trial_response = 'l';
                            }
                            else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n" || jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(last_trial_data.key_press) == "n") {
                                trial_response = 'r';
                            }
                        }
                        // if successful inhibition, increase SSD so that it is harder to stop
                        else {
                          delay += 25;
                        }

                        // add accuracy to the data for this trial
                        data.trial_response = trial_response;
                        data.successful_inhibit = inhibit;
                        data.correct = correct;
                    }
                }
                // add the no-go arrow trial (no-go trials only)
                timeline.push(stop_signal);
            } else {
                // set up the go trial and add to timeline
                var target_arrow = {
                    type: 'image-keyboard-response',
                    stimulus: block3_trial_info[i].arrow_image,
                    choices: ['c','n'],
                    response_ends_trial: true,
                    trial_duration: 1000,
                    post_trial_gap: 500,
                    data: {
                      block: 'block3',
                      trial_absolute: function() {
                        return trial_absolute_count;
                      },
                      trial_within: function() {
                        return block3_within_count;
                      },
                      trial_go_number: function() {
                        return block3_go_count;
                      },
                      emotion_type: block3_trial_info[i].emotion_type,
                      trial_segment: 'target',
                      condition: block3_trial_info[i].condition,
                      arrow_direction: block3_trial_info[i].arrow_direction,
                      arrow_key_correct: block3_trial_info[i].arrow_key_correct,
                      trial_response_correct: block3_trial_info[i].trial_response_correct
                    },
                    on_finish: function(data) {
                        // score response
                        trial_absolute_count += 1;
                        block3_go_count += 1;
                        block3_within_count += 1;
                        var correct = false;
                        var trial_response = 'x';
                        // if we add the correct key response to the trial data, then we can use it to score the response
                        if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == data.arrow_key_correct) {
                            correct = true;
                        }

                        if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                            trial_response = 'l';
                        }
                        else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                            trial_response = 'r';
                        }
                        // add accuracy to data for this trial
                        data.correct = correct;
                        data.trial_response = trial_response;
                    }
                };
                timeline.push(target_arrow);
            }
        }

        // add end message
        var end = {
            type: 'html-keyboard-response',
            stimulus: '<p>Great! You&#39;re done with this task.</p><p>Thank you for your time.</p>',
            trial_duration: 5000
        };

        jsPsych.init({
            timeline: timeline,
            on_finish: function(data) {
                // see docs for info on data formatting and saving:
                // https://www.jspsych.org/core_library/jspsych-data/#csv
                // https://www.jspsych.org/core_library/jspsych-data/#json
                // https://www.jspsych.org/core_library/jspsych-data/#localsave
                jsPsych.data.get().localSave("csv","go_stop_data.csv");
            }
        });

    </script>
</html>
